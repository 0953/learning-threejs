<!DOCTYPE html>

<html>

<head>
    <title>Rigid body - Physijs</title>



    <script type="text/javascript" src="../libs/three.js"></script>
    <script type="text/javascript" src="../libs/stats.js"></script>
    <script type="text/javascript" src="../libs/physi.js"></script>

    <script type="text/javascript">

        'use strict';

        Physijs.scripts.worker = '../libs/physijs_worker.js';
        Physijs.scripts.ammo = '../libs/ammo.js';

        var initScene, render, applyForce, setMousePosition, mouse_position,
                ground_material, box_material,
                projector, renderer, render_stats, physics_stats, scene, ground, light, camera, box, boxes = [];

        initScene = function() {
            projector = new THREE.Projector;

            renderer = new THREE.WebGLRenderer({ antialias: true });
            renderer.setSize( window.innerWidth, window.innerHeight );

            renderer.setClearColorHex(0x000000);
            document.getElementById( 'viewport' ).appendChild( renderer.domElement );

            render_stats = new Stats();
            render_stats.domElement.style.position = 'absolute';
            render_stats.domElement.style.top = '1px';
            render_stats.domElement.style.zIndex = 100;
            document.getElementById( 'viewport' ).appendChild( render_stats.domElement );

            physics_stats = new Stats();
            physics_stats.domElement.style.position = 'absolute';
            physics_stats.domElement.style.top = '50px';
            physics_stats.domElement.style.zIndex = 100;
            document.getElementById( 'viewport' ).appendChild( physics_stats.domElement );

            scene = new Physijs.Scene;
            scene.setGravity(new THREE.Vector3( 0, -90, 0 ));

            camera = new THREE.PerspectiveCamera(
                    35,
                    window.innerWidth / window.innerHeight,
                    1,
                    1000
            );
            camera.position.set( 100, 100, 100 );
            camera.lookAt( scene.position );
            scene.add( camera );

            // Light
            light = new THREE.SpotLight( 0xFFFFFF );
            light.position.set( 20, 100, 50 );


            scene.add( light );

            // Materials
            ground_material = Physijs.createMaterial(
                    new THREE.MeshPhongMaterial({ map: THREE.ImageUtils.loadTexture( '../assets/textures/general/bathroom.jpg' ) }),
                    .3, // high friction
                    .3 // low restitution
            );
            ground_material.map.wrapS = ground_material.map.wrapT = THREE.RepeatWrapping;
            ground_material.map.repeat.set( 4, 8 );

            // Ground
            ground = new Physijs.BoxMesh(
                    new THREE.CubeGeometry(60, 1, 130),
                    ground_material,
                    0 // mass
            );
            ground.receiveShadow = true;


            var borderLeft = new Physijs.BoxMesh(
                    new THREE.CubeGeometry(2, 6, 130),
                    ground_material,
                    0 // mass
            );

            borderLeft.position.x=-31;
            borderLeft.position.y=2;


            ground.add(borderLeft);

            var borderRight = new Physijs.BoxMesh(new THREE.CubeGeometry(2, 6, 130),
                    ground_material,
                    0 // mass
            );
            borderRight.position.x=31;
            borderRight.position.y=2;

            ground.add(borderRight);


            var borderBottom = new Physijs.BoxMesh(
                    new THREE.CubeGeometry(64, 6, 2),
                    ground_material,
                    0 // mass
            );

            borderBottom.position.z=65;
            borderBottom.position.y=2;
            ground.add(borderBottom);

            var borderTop = new Physijs.BoxMesh(
                    new THREE.CubeGeometry(64, 6, 2),
                    ground_material,
                    0 // mass
            );

            borderTop.position.z=-65;
            borderTop.position.y=2;
            ground.add(borderTop);

            var pilar_material = Physijs.createMaterial(
                    new THREE.MeshPhongMaterial({color:0xff3333}),
                    .3, // high friction
                    .9 // low restitution
            );

            var pilar = new Physijs.CylinderMesh(new THREE.CylinderGeometry(2,2,24),pilar_material,0);
            ground.add(pilar);


            var pilar2 = new Physijs.CylinderMesh(new THREE.CylinderGeometry(2,2,24),pilar_material,0);
            pilar2.position.x=15;
            ground.add(pilar2);


            var pilar3 = new Physijs.CylinderMesh(new THREE.CylinderGeometry(2,2,24),pilar_material,0);
            ground.add(pilar3);
            pilar3.position.x=-15;




            scene.add(ground);

            for ( var i = 0; i < 40; i++ ) {
                box = new Physijs.SphereMesh(
//                        new THREE.CubeGeometry( 4, 4, 4 ),
                        new THREE.SphereGeometry( 2, 20 ),
                        Physijs.createMaterial(
                                new THREE.MeshPhongMaterial({ map: THREE.ImageUtils.loadTexture( '../assets/textures/general/floor-wood.jpg' ) }),
                                .1, // low friction
                                .3 // high restitution
                        )
                );
                box.position.set(
                        Math.random() * 50 -25,
                       20 + Math.random() * 5,
                        Math.random() * 50 -25
                );
                box.rotation.set(
                        Math.random() * Math.PI * 2,
                        Math.random() * Math.PI * 2,
                        Math.random() * Math.PI * 2
                );
//                box.scale.set(
//                        Math.random() * 1 + .5,
//                        Math.random() * 1 + .5,
//                        Math.random() * 1 + .5
//                );

                scene.add( box );
                boxes.push( box );
            }

            requestAnimationFrame( render );
            scene.simulate();
        };

        var stepX;
        var direction=1;

        render = function() {
            requestAnimationFrame( render );
            renderer.render( scene, camera );
            render_stats.update();
            ground.rotation.x+=0.002 * direction;

            if (ground.rotation.x < -0.4) direction =1;
            if (ground.rotation.x > 0.4) direction =-1;
            ground.__dirtyRotation = true;
            scene.simulate(undefined,1 );
        };


        window.onload = initScene;

    </script>
</head>

<body>
<div id="viewport"></div>
</body>

</html>
